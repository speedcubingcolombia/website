---
interface Tab {
  label: string;
  slug: string;
  isActive: boolean;
}

interface Props {
  tabs: Tab[];
  baseSlug: string;
  /** Language prefix for URLs (e.g., '/en', '/pt' or '' for Spanish) */
  langPrefix?: string;
}

const { tabs, baseSlug, langPrefix = "" } = Astro.props;
const activeTab = tabs.find((tab) => tab.isActive);
const basePath = `${langPrefix}/blog`;
---

<nav
  class="sticky top-0 z-40 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 mb-6 pt-2"
>
  <div class="container-custom max-w-4xl">
    <!-- Móvil: Menú hamburguesa -->
    <div class="md:hidden pb-2">
      <button
        id="tabs-menu-button"
        class="flex items-center justify-between w-full px-5 py-3 text-base font-semibold text-white bg-primary-600 rounded-lg hover:bg-primary-700 active:bg-primary-800 shadow-md transition-all"
        aria-expanded="false"
      >
        <span>{activeTab?.label || "Menú"}</span>
        <svg
          class="w-6 h-6 transition-transform"
          id="tabs-menu-icon"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M19 9l-7 7-7-7"></path>
        </svg>
      </button>

      <!-- Menú desplegable móvil -->
      <div
        id="tabs-menu-dropdown"
        class="hidden absolute left-0 right-0 mt-2 mx-4 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden"
      >
        {
          tabs.map((tab) => (
            <a
              href={
                tab.slug === "index"
                  ? `${basePath}/${baseSlug}`
                  : `${basePath}/${baseSlug}/${tab.slug}`
              }
              class={`
              block px-4 py-3 text-sm font-medium transition-colors
              ${
                tab.isActive
                  ? "bg-primary-600 text-white"
                  : "text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"
              }
            `}
            >
              {tab.label}
            </a>
          ))
        }
      </div>
    </div>

    <!-- Desktop: Pestañas horizontales -->
    <div class="hidden md:block relative pb-2">
      <div
        id="tabs-container"
        class="flex gap-2 overflow-x-auto scrollbar-hide"
      >
        {
          tabs.map((tab) => (
            <a
              href={
                tab.slug === "index"
                  ? `${basePath}/${baseSlug}`
                  : `${basePath}/${baseSlug}/${tab.slug}`
              }
              class={`
            px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-colors flex-shrink-0
            ${
              tab.isActive
                ? "bg-primary-600 text-white shadow-sm"
                : "text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800"
            }
          `}
            >
              {tab.label}
            </a>
          ))
        }
      </div>
      <!-- Botón de navegación derecho -->
      <button
        id="scroll-indicator-right"
        class="scroll-indicator-right"
        aria-label="Scroll right"
        type="button"
      >
      </button>
      <!-- Botón de navegación izquierdo -->
      <button
        id="scroll-indicator-left"
        class="scroll-indicator-left hidden"
        aria-label="Scroll left"
        type="button"
      >
      </button>
    </div>
  </div>
</nav>

<script is:inline>
  function initTabsMenu() {
    const menuButton = document.getElementById("tabs-menu-button");
    const menuDropdown = document.getElementById("tabs-menu-dropdown");
    const menuIcon = document.getElementById("tabs-menu-icon");

    if (menuButton && menuDropdown && menuIcon) {
      // Remover listeners previos si existen
      const newMenuButton = menuButton.cloneNode(true);
      menuButton.parentNode.replaceChild(newMenuButton, menuButton);

      newMenuButton.addEventListener("click", (e) => {
        e.stopPropagation();
        const isExpanded =
          newMenuButton.getAttribute("aria-expanded") === "true";

        newMenuButton.setAttribute("aria-expanded", (!isExpanded).toString());
        menuDropdown.classList.toggle("hidden");
        menuIcon.style.transform = isExpanded
          ? "rotate(0deg)"
          : "rotate(180deg)";
      });

      // Cerrar menú al hacer clic fuera
      document.addEventListener("click", (e) => {
        const target = e.target;
        if (
          target &&
          !newMenuButton.contains(target) &&
          !menuDropdown.contains(target)
        ) {
          newMenuButton.setAttribute("aria-expanded", "false");
          menuDropdown.classList.add("hidden");
          menuIcon.style.transform = "rotate(0deg)";
        }
      });
    }
  }

  function initScrollIndicators() {
    const container = document.getElementById("tabs-container");
    const indicatorRight = document.getElementById("scroll-indicator-right");
    const indicatorLeft = document.getElementById("scroll-indicator-left");

    if (!container || !indicatorRight || !indicatorLeft) return;

    // Restaurar posición de scroll guardada
    const savedScrollPosition = sessionStorage.getItem("tabsScrollPosition");
    if (savedScrollPosition) {
      container.scrollLeft = parseInt(savedScrollPosition, 10);
    }

    function updateIndicators() {
      const hasOverflow = container.scrollWidth > container.clientWidth;
      const isAtStart = container.scrollLeft <= 5;
      const isAtEnd =
        container.scrollLeft >=
        container.scrollWidth - container.clientWidth - 5;

      if (!hasOverflow) {
        indicatorRight.classList.add("hidden");
        indicatorLeft.classList.add("hidden");
      } else {
        indicatorRight.classList.toggle("hidden", isAtEnd);
        indicatorLeft.classList.toggle("hidden", isAtStart);
      }
    }

    // Función para desplazar suavemente
    function scrollBy(distance) {
      container.scrollBy({
        left: distance,
        behavior: "smooth",
      });
    }

    // Click en botón derecho
    indicatorRight.addEventListener("click", () => {
      scrollBy(200);
    });

    // Click en botón izquierdo
    indicatorLeft.addEventListener("click", () => {
      scrollBy(-200);
    });

    // Actualizar indicadores al hacer scroll
    container.addEventListener("scroll", () => {
      updateIndicators();
      // Guardar posición de scroll
      sessionStorage.setItem("tabsScrollPosition", container.scrollLeft.toString());
    });

    // Actualizar en resize
    window.addEventListener("resize", updateIndicators);

    // Actualizar inicialmente
    updateIndicators();
  }

  // Inicializar en carga inicial
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      initTabsMenu();
      initScrollIndicators();
    });
  } else {
    initTabsMenu();
    initScrollIndicators();
  }

  // Reinicializar después de transiciones de Astro
  document.addEventListener("astro:after-swap", () => {
    initTabsMenu();
    initScrollIndicators();
  });
</script>

<style>
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  .scroll-indicator-right,
  .scroll-indicator-left {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 80px;
    pointer-events: auto;
    z-index: 10;
    transition: opacity 0.3s ease;
    border: none;
    background: transparent;
    cursor: pointer;
  }

  .scroll-indicator-right:hover::after,
  .scroll-indicator-left:hover::after {
    opacity: 1;
    animation-play-state: paused;
  }

  .scroll-indicator-right {
    right: 0;
    background: linear-gradient(
      to left,
      rgba(255, 255, 255, 1) 0%,
      rgba(255, 255, 255, 0.9) 40%,
      rgba(255, 255, 255, 0) 100%
    );
  }

  .scroll-indicator-left {
    left: 0;
    background: linear-gradient(
      to right,
      rgba(255, 255, 255, 1) 0%,
      rgba(255, 255, 255, 0.9) 40%,
      rgba(255, 255, 255, 0) 100%
    );
  }

  :global(.dark) .scroll-indicator-right {
    background: linear-gradient(
      to left,
      rgba(17, 24, 39, 1) 0%,
      rgba(17, 24, 39, 0.9) 40%,
      rgba(17, 24, 39, 0) 100%
    );
  }

  :global(.dark) .scroll-indicator-left {
    background: linear-gradient(
      to right,
      rgba(17, 24, 39, 1) 0%,
      rgba(17, 24, 39, 0.9) 40%,
      rgba(17, 24, 39, 0) 100%
    );
  }

  .scroll-indicator-right::after,
  .scroll-indicator-left::after {
    content: "";
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-style: solid;
  }
  .scroll-indicator-right::after {
    right: 16px;
    border-width: 8px 0 8px 10px;
    border-color: transparent transparent transparent #6b7280;
    animation: pulse-right 2s ease-in-out infinite;
  }

  .scroll-indicator-left::after {
    left: 16px;
    border-width: 8px 10px 8px 0;
    border-color: transparent #6b7280
    border-width: 6px 8px 6px 0;
    border-color: transparent #9ca3af transparent transparent;
    animation: pulse-left 2s ease-in-out infinite;
  }

  @keyframes pulse-right {
    0%,
    100% {
      transform: translateY(-50%) translateX(0);
      opacity: 0.6;
    }
    50% {
      transform: translateY(-50%) translateX(4px);
      opacity: 1;
    }
  }

  @keyframes pulse-left {
    0%,
    100% {
      transform: translateY(-50%) translateX(0);
      opacity: 0.6;
    }
    50% {
      transform: translateY(-50%) translateX(-4px);
      opacity: 1;
    }
  }
</style>
