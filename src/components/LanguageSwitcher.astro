---
/**
 * LanguageSwitcher component for multi-language support
 * Shows flags for available languages and allows switching between them
 * Only renders if there are translations available (more than 1 language)
 */
import { SLUG_TRANSLATIONS } from "../utils/blog";

interface Props {
  currentLang?: string;
  currentSlug?: string;
  /** List of available language codes for this content (e.g., ['es', 'en', 'pt']) */
  availableLanguages?: string[];
  class?: string;
}

const { 
  currentLang = 'es', 
  currentSlug = '',
  availableLanguages = [],
  class: className = '' 
} = Astro.props;

// Define all available languages with their properties
const allLanguages = [
  { code: 'es', flag: 'ðŸ‡¨ðŸ‡´', name: 'EspaÃ±ol', prefix: '' },
  { code: 'en', flag: 'ðŸ‡ºðŸ‡¸', name: 'English', prefix: '/en' },
  { code: 'pt', flag: 'ðŸ‡§ðŸ‡·', name: 'PortuguÃªs', prefix: '/pt' }
];

// Only show languages that have translations for this content
const languages = availableLanguages.length > 0
  ? allLanguages.filter(lang => availableLanguages.includes(lang.code))
  : allLanguages;

// Don't render if only one language available (no translations)
const hasTranslations = languages.length > 1;

/**
 * Get the URL for a specific language
 */
function getLanguageUrl(targetLang: string): string {
  // currentSlug is already in canonical (Spanish) form
  const canonicalSlug = currentSlug;
  
  // Get the translated slug for target language
  let targetSlug = canonicalSlug;
  const translations = SLUG_TRANSLATIONS[canonicalSlug];
  if (targetLang !== 'es' && translations) {
    const translatedSlug = translations[targetLang as 'es' | 'en' | 'pt'];
    if (translatedSlug) {
      targetSlug = translatedSlug;
    }
  }
  
  // Build the URL with language prefix
  const lang = allLanguages.find(l => l.code === targetLang);
  const prefix = lang?.prefix || '';
  
  return `${prefix}/blog/${targetSlug}`;
}
---

{hasTranslations && (
  <div class:list={["language-switcher flex items-center gap-1", className]} x-data="{ open: false }">
    <div class="relative">
      <button
        @click="open = !open"
        @click.outside="open = false"
        class="flex items-center gap-1 px-2 py-1 rounded-md hover:bg-secondary-100 dark:hover:bg-secondary-800 transition-colors"
        aria-label="Cambiar idioma"
        aria-expanded="false"
        :aria-expanded="open.toString()"
      >
        <span class="text-lg" role="img" aria-label={languages.find(l => l.code === currentLang)?.name}>
          {languages.find(l => l.code === currentLang)?.flag}
        </span>
        <svg 
          class="w-4 h-4 text-secondary-500 transition-transform"
          :class="{ 'rotate-180': open }"
          fill="none" 
          stroke="currentColor" 
          viewBox="0 0 24 24"
        >
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      
      <div
        x-show="open"
        x-transition:enter="transition ease-out duration-100"
        x-transition:enter-start="transform opacity-0 scale-95"
        x-transition:enter-end="transform opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-75"
        x-transition:leave-start="transform opacity-100 scale-100"
        x-transition:leave-end="transform opacity-0 scale-95"
        class="absolute right-0 mt-2 py-1 w-40 bg-white dark:bg-secondary-800 rounded-lg shadow-lg border border-secondary-200 dark:border-secondary-700 z-50"
        role="menu"
        aria-label="Selector de idioma"
      >
        {languages.map((lang) => (
          <a
            href={getLanguageUrl(lang.code)}
            class:list={[
              "flex items-center gap-2 px-3 py-2 hover:bg-secondary-100 dark:hover:bg-secondary-700 transition-colors",
              { "bg-accent-50 dark:bg-accent-900/30 text-accent-600 dark:text-accent-400": currentLang === lang.code }
            ]}
            role="menuitem"
            aria-current={currentLang === lang.code ? "page" : undefined}
          >
            <span class="text-lg" role="img" aria-label={lang.name}>{lang.flag}</span>
            <span class="text-sm font-medium">{lang.name}</span>
          </a>
        ))}
      </div>
    </div>
  </div>
)}
